# Fichier d'override pour le dÃ©veloppement local
# Utilisation: docker-compose -f docker-compose.yml -f docker-compose.dev.yml up

# âœ… OPTIMISATION: Utilisation des profils pour sÃ©parer les services.
# Le profil "dev" inclut les services et configurations spÃ©cifiques au dÃ©veloppement.

services:
  web:
    # âœ… DEV MODE: Utiliser le serveur de dÃ©veloppement Flask avec rechargement automatique.
    command: >
      bash -c "echo 'ðŸ”§ DÃ©marrage en mode DÃ‰VELOPPEMENT...' &&
               flask run --host=0.0.0.0 --port=5000"
    environment:
      - FLASK_ENV=development # Active le mode debug et le rechargement
    volumes:
      # Monter le code source pour le rechargement Ã  chaud
      - ./api:/home/appuser/app/api
      - ./backend:/home/appuser/app/backend
      - ./scripts:/home/appuser/app/scripts
      - ./utils:/home/appuser/app/utils
      - ./web:/home/appuser/app/web
      - ./migrations:/home/appuser/app/migrations
      - ./alembic.ini:/home/appuser/app/alembic.ini
      - ./pytest.ini:/home/appuser/app/pytest.ini
    # En mode dev, on attend aussi la base de test
    depends_on:
      test-db:
        condition: service_started

  test-db:
    # Ce service ne sera dÃ©marrÃ© qu'avec le profil "dev"
    profiles:
      - dev

  worker-fast:
    volumes:
      - ./backend:/home/appuser/app/backend
      - ./api:/home/appuser/app/api
      - ./utils:/home/appuser/app/utils

  worker-default:
    volumes:
      - ./backend:/home/appuser/app/backend
      - ./api:/home/appuser/app/api
      - ./utils:/home/appuser/app/utils

  worker-ai:
    volumes:
      - ./backend:/home/appuser/app/backend
      - ./api:/home/appuser/app/api
      - ./utils:/home/appuser/app/utils

  migrate:
    # En mode dev, on veut aussi que migrate utilise les derniers fichiers locaux
    volumes:
      - ./api:/home/appuser/app/api
      - ./backend:/home/appuser/app/backend
      - ./scripts:/home/appuser/app/scripts
      - ./utils:/home/appuser/app/utils
      - ./migrations:/home/appuser/app/migrations
      - ./alembic.ini:/home/appuser/app/alembic.ini
      - ./scripts/entrypoint.sh:/home/appuser/app/entrypoint.sh # âœ… CORRECTION: Utiliser le bon chemin source pour le script.
    depends_on:
      test-db:
        condition: service_started