# Utilise l'image de base qui contient Python/venv/dépendances
FROM analylit-base:latest AS base

# Outils utiles (psql pour checks, netcat pour waits)
USER root
RUN apt-get update \
 && apt-get install -y --no-install-recommends netcat-openbsd postgresql-client \
 && rm -rf /var/lib/apt/lists/*

# Répertoire de travail
USER appuser
WORKDIR /home/appuser/app

# CORRECTION: Assurer que l'utilisateur est propriétaire du répertoire de travail
RUN chown -R appuser:appuser /home/appuser/app

# Copie TOUT le code de l'application (Python + web + configs)
# Assure-toi que .dockerignore n'exclut pas des répertoires nécessaires (utils/, api/, profiles.json, etc.)
COPY --chown=appuser:appuser . /home/appuser/app/

# Rendre l'entrypoint exécutable
RUN chmod +x /home/appuser/app/entrypoint.sh

# Le service écoute en 5001 (Gunicorn)
EXPOSE 5001

# L'entrypoint gère l'attente DB, l'init DB/seed unique, puis lance Gunicorn
ENTRYPOINT ["/home/appuser/app/entrypoint.sh"]
