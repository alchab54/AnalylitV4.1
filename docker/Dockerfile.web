# Utilise l'image de base qui contient Python/venv/dépendances
FROM analylit-base:latest AS base

# Outils utiles (psql pour checks, netcat pour waits)
USER root
RUN apt-get update \
 && apt-get install -y --no-install-recommends netcat-openbsd postgresql-client \
 && rm -rf /var/lib/apt/lists/*

# Répertoire de travail
USER appuser
WORKDIR /home/appuser/app

# Copie le code de l'application
COPY . .

# CORRECTION: Assurer que l'utilisateur est propriétaire du répertoire de travail et rendre l'entrypoint exécutable
USER root
RUN chown -R appuser:appuser /home/appuser/app && \
    chmod +x /home/appuser/app/entrypoint.sh
USER appuser


# Le service écoute en 5001 (Gunicorn)
EXPOSE 5001

# L'entrypoint gère l'attente DB, l'init DB/seed unique, puis lance Gunicorn
ENTRYPOINT ["/home/appuser/app/entrypoint.sh"]
