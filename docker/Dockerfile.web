# Image applicative - hérite de la base avec les dépendances
FROM analylit-base:latest

# ✅ CORRECTION ROBUSTE: Copier tous les fichiers et répertoires du contexte de build.
# Cela garantit que la structure des dossiers (y compris 'migrations') est préservée sans ambiguïté.
COPY --chown=appuser:appuser . .

# La commande ci-dessus a déjà copié alembic.ini, donc la ligne suivante n'est plus nécessaire.
# COPY --chown=appuser:appuser alembic.ini ./

# Corrige les fins de ligne Windows (\r) et rend le script exécutable
RUN tr -d '\r' < entrypoint.sh > entrypoint-fixed.sh && \
    rm entrypoint.sh && \
    mv entrypoint-fixed.sh entrypoint.sh && \
    chmod +x entrypoint.sh

ENTRYPOINT ["./entrypoint.sh"]
