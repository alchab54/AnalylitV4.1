# Hérite de l'image de base (dépendances déjà installées)
FROM analylit-base:latest

# Copier le code (copie tout y compris docker/entrypoint.sh)
COPY --chown=appuser:appuser profiles.json ./
COPY --chown=appuser:appuser server_v4_complete.py config_v4.py tasks_v4_complete.py ./
COPY --chown=appuser:appuser api/ api/
COPY --chown=appuser:appuser utils/ utils/
COPY --chown=appuser:appuser web/ web/
COPY --chown=appuser:appuser entrypoint.sh ./

# Positionner *le chmod* SUR LE FICHIER avec CHEMIN CORRECT
USER root
RUN chmod +x entrypoint.sh

# Create logs and projects directories and set permissions
RUN mkdir -p /home/appuser/app/logs && chown appuser:appuser /home/appuser/app/logs
RUN mkdir -p /home/appuser/app/projects && chown appuser:appuser /home/appuser/app/projects
USER appuser

EXPOSE 5000
ENTRYPOINT ["./entrypoint.sh"]
