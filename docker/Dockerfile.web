# docker/Dockerfile.web
FROM analylit-base-cpu:latest

# Copier le code de l'application.
COPY . .

# RUN apt-get update as root
USER root

# ✅ SUPPRIMÉ: Téléchargement wget (plus nécessaire)
# Les scripts sont maintenant vendorisés dans le repo

# --- Correction des permissions et des fins de ligne ---
# 1. Basculer temporairement vers l'utilisateur root.
USER root

# 2. Corriger les fins de ligne Windows (\r) et rendre les scripts exécutables.
RUN tr -d '\r' < scripts/entrypoint.sh > /tmp/entrypoint-fixed.sh && \
    chmod +x /tmp/entrypoint-fixed.sh && \
    mv /tmp/entrypoint-fixed.sh scripts/entrypoint.sh

# ✅ AJOUT: Rendre wait-for-it.sh exécutable
RUN tr -d '\r' < scripts/wait-for-it.sh > /tmp/wait-for-it-fixed.sh && \
    chmod +x /tmp/wait-for-it-fixed.sh && \
    mv /tmp/wait-for-it-fixed.sh scripts/wait-for-it.sh

# 3. Revenir à l'utilisateur non-root et s'assurer qu'il est propriétaire des fichiers.
RUN chown -R appuser:appuser /home/appuser/app
USER appuser

ENTRYPOINT ["./scripts/entrypoint.sh"] 
